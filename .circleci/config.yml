version: 2

aliases:

  # Restore Composer cache.
  - &steps_cache_restore_composer
    restore_cache:
      name: Restore Composer cache
      keys:
      - v1-composer-{{ checksum "backend/composer.json" }}-{{ checksum "backend/composer.lock" }}

  # Restore NPM cache.
  - &steps_cache_restore_npm
    restore_cache:
      name: Restore NPM cache
      keys:
      - v1-npm-{{ checksum "frontend/package.json" }}-{{ checksum "frontend/package-lock.json" }}

jobs:

  build:
    machine: true
    working_directory: ~/repo

    steps:
      - checkout

      # Restore caches.
      - *steps_cache_restore_composer
      - *steps_cache_restore_npm

      # Modify permissions so the PHP and Node containers can build their
      # dependencies.
      - run:
          name: Fix permissions
          command: sudo chown -R ubuntu.ubuntu *

      # Setup the .env file.
      - run:
          name: Setup the project .env file
          command: sed 's/MEETUP_API_KEY=/MEETUP_API_KEY='"$MEETUP_API_KEY"'/g' .env-example > .env

      # Run the Makefile install command.
      - run:
          name: Run the Makefile install command
          command: make install

      # Save composer cache.
      - save_cache:
          name: Save Composer cache
          paths:
            - ./backend/bin
            - ./backend/vendor
            - ./backend/web/core
            - ./backend/web/modules/contrib
            - ./backend/web/profiles/contrib
            - ./backend/web/themes/contrib
            - ./backend/web/libraries
          key: v1-composer-{{ checksum "backend/composer.json" }}-{{ checksum "backend/composer.lock" }}

      # Save npm cache.
      - save_cache:
          name: Save NPM cache
          paths:
            - ./frontend/node_modules
          key: v1-npm-{{ checksum "frontend/package.json" }}-{{ checksum "frontend/package-lock.json" }}

      # Save nuxt cache.
      - save_cache:
          name: Save Nuxt.js cache
          paths:
            - ./frontend/.nuxt
          key: v1-nuxt-$CIRCLE_SHA1

      # Backup installed database.
      - run:
          name: Backup installed database
          command: make db-export database.sql

      # Store database in workspace.
      - persist_to_workspace:
          root: ~/repo
          paths:
            - .env
            - database/database.sql

      # Store install artifacts.
      - store_artifacts:
          name: Store install artifacts
          path: ~/repo/database/database.sql
          destination: database/database.sql

  test:
    machine: true
    working_directory: ~/repo

    steps:
      - checkout

      # Restore workspace
      - attach_workspace:
          at: ~/repo

      # Restore caches.
      - *steps_cache_restore_composer
      - *steps_cache_restore_npm
      - restore_cache:
          name: Restore Nuxt.js cache
          keys:
            - v1-nuxt-$CIRCLE_SHA1

      # Modify permissions so the PHP and Node containers can build their
      # dependencies.
      - run:
          name: Fix permissions
          command: sudo chown -R ubuntu.ubuntu *

      # Spin up Docker containers.
      - run:
          name: Turn on Docker containers
          command: make up

      # Run code linting.
      - run:
          name: Running code linting
          command: make lint

      # Wait for database.
      - run:
          name: Wait for database to start
          command: make db-status

      # Importing database backup.
      - run:
          name: Import database backup
          command: make db-import database.sql

      # Run Behat tests.
      - run:
          name: Run Behat tests
          command: make test-behat

      # Save Behat artefacts.
      - store_artifacts:
          name: Store Behat artefacts
          path: ~/repo/tests/behat/artefacts
          destination: behat

      # Run BackstopJS tests.
      - run:
          name: Run BackstopJS tests
          # @TODO: Replace below once BackstopJS tests are expecte to pass.
          # command: make test-backstopjs
          command: make test-backstopjs || true

      # Save BackstopJS artefacts.
      - store_artifacts:
          name: Store BackstopJS artefacts
          path: ~/repo/tests/backstopjs/artefacts
          destination: backstopjs

      # Save test results.
      - store_test_results:
          path: ~/repo/tests/results

workflows:
  version: 2

  build:
    jobs:
      - build
      - test:
          requires:
            - build
